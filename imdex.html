<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>NAMECOMMS V14: PROVOST MARSHAL</title>
<style>
    :root {
        --bg: #000000;
        --surface: #121214;
        --surface-light: #1c1c1e;
        --primary: #0a84ff;
        --primary-dim: rgba(10, 132, 255, 0.2);
        --danger: #ff453a;
        --warn: #ffd60a;
        --success: #30d158;
        --text: #ffffff;
        --text-sec: #98989d;
        --border: #38383a;
        --notch-padding: env(safe-area-inset-top);
        --bottom-padding: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif; }

    body {
        margin: 0; background-color: var(--bg); color: var(--text);
        height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
    }

    /* --- LAYOUT --- */
    header {
        padding-top: max(20px, var(--notch-padding));
        height: calc(60px + var(--notch-padding));
        background: rgba(18, 18, 20, 0.8);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border-bottom: 0.5px solid var(--border);
        display: flex; align-items: center; justify-content: space-between; padding-left: 20px; padding-right: 20px;
        position: absolute; top: 0; width: 100%; z-index: 50;
    }
    .brand { font-size: 17px; font-weight: 700; letter-spacing: 0.5px; }
    .brand span { color: var(--primary); }
    .status-badge { font-size: 11px; font-weight: 600; padding: 4px 8px; background: #333; border-radius: 6px; color: var(--text-sec); }
    .status-badge.active { background: var(--primary-dim); color: var(--primary); box-shadow: 0 0 10px var(--primary-dim); }

    /* --- VISUALIZER AREA (Top Half) --- */
    #vis-container {
        flex: 1; position: relative; margin-top: calc(60px + var(--notch-padding));
        display: flex; flex-direction: column; background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
    }
    
    .hologram-box {
        flex: 1; display: flex; align-items: center; justify-content: center; flex-direction: column;
    }
    #big-word {
        font-size: 42px; font-weight: 800; text-align: center;
        color: transparent; -webkit-text-stroke: 1px var(--primary);
        text-shadow: 0 0 20px var(--primary); opacity: 0; transition: opacity 0.2s;
        padding: 0 20px; line-height: 1.1;
    }
    #z-readout {
        margin-top: 10px; font-family: "SF Mono", monospace; font-size: 14px; color: var(--text-sec); opacity: 0; transition: opacity 0.2s;
    }

    canvas { width: 100%; height: 160px; display: block; }

    /* --- CONTROL DECK (Bottom Half) --- */
    #deck {
        background: var(--surface); border-top: 0.5px solid var(--border);
        padding-bottom: var(--bottom-padding); z-index: 60;
        display: flex; flex-direction: column;
    }

    /* TABS */
    .tab-bar {
        display: flex; height: 50px; border-bottom: 0.5px solid var(--border);
    }
    .tab-btn {
        flex: 1; background: transparent; border: none; color: var(--text-sec);
        font-size: 13px; font-weight: 600; transition: 0.2s;
    }
    .tab-btn.active { color: var(--text); background: var(--surface-light); border-bottom: 2px solid var(--primary); }

    /* PANELS */
    .panel { display: none; height: 280px; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }
    .panel.active { display: block; }

    /* UI ELEMENTS */
    .ios-slider-group { margin-bottom: 25px; }
    .ios-label { display: flex; justify-content: space-between; font-size: 13px; color: var(--text-sec); margin-bottom: 10px; font-weight: 500; }
    
    input[type=range] {
        width: 100%; height: 6px; background: #333; border-radius: 3px; -webkit-appearance: none;
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none; height: 28px; width: 28px; background: #fff; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    }

    .btn-large {
        width: 100%; padding: 16px; border-radius: 14px; background: var(--surface-light);
        color: var(--primary); font-size: 17px; font-weight: 600; border: none; margin-bottom: 12px;
        transition: 0.1s; display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-large:active { transform: scale(0.98); opacity: 0.8; }
    .btn-large.primary { background: var(--primary); color: #fff; }
    .btn-large.danger { background: rgba(255, 69, 58, 0.15); color: var(--danger); }
    .btn-large.recording { background: var(--danger); color: #fff; animation: pulse 1.5s infinite; }

    /* LOGS */
    .log-item {
        display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 0.5px solid #222; font-size: 15px;
    }
    .log-word { font-weight: 700; color: var(--text); }
    .log-meta { font-family: "SF Mono", monospace; color: var(--text-sec); font-size: 12px; }
    .log-item.anomaly .log-word { color: var(--warn); }
    .log-item.critical .log-word { color: var(--danger); }

    /* OVERLAY */
    #overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        z-index: 999; display: flex; align-items: center; justify-content: center; flex-direction: column;
        padding: 40px; text-align: center;
    }
    .overlay-icon { font-size: 40px; margin-bottom: 20px; color: var(--primary); }
    h2 { margin: 0 0 10px 0; font-size: 24px; }
    p { color: var(--text-sec); margin: 0 0 30px 0; line-height: 1.5; font-size: 15px; }

    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

</style>
</head>
<body>

<header>
    <div class="brand">NC<span>XIV</span></div>
    <div class="status-badge" id="sys-status">OFFLINE</div>
</header>

<div id="vis-container">
    <div class="hologram-box">
        <div id="big-word">INITIALIZING</div>
        <div id="z-readout">Z: 0.00σ</div>
    </div>
    <canvas id="scope"></canvas>
</div>

<div id="deck">
    <div class="tab-bar">
        <button class="tab-btn active" onclick="UI.tab('controls')">CONTROLS</button>
        <button class="tab-btn" onclick="UI.tab('evp')">EVP RECORDER</button>
        <button class="tab-btn" onclick="UI.tab('logs')">LOGS</button>
    </div>

    <!-- CONTROLS PANEL -->
    <div id="p-controls" class="panel active">
        
        <button class="btn-large primary" id="btn-power" onclick="App.togglePower()">
            <span id="txt-power">ACTIVATE SYSTEM</span>
        </button>

        <div class="ios-slider-group">
            <div class="ios-label"><span>Entropy Mix</span><span id="val-mix">50% MIC</span></div>
            <input type="range" value="50" oninput="Engine.setMix(this.value)">
        </div>

        <div class="ios-slider-group">
            <div class="ios-label"><span>Synth Volume</span><span id="val-vol">50%</span></div>
            <input type="range" value="50" oninput="Engine.setVol(this.value)">
        </div>

        <div class="ios-slider-group">
            <div class="ios-label"><span>Anomaly Threshold</span><span id="val-thresh">3.5σ</span></div>
            <input type="range" min="2.5" max="6.0" step="0.1" value="3.5" oninput="Engine.setThresh(this.value)">
        </div>

    </div>

    <!-- EVP PANEL -->
    <div id="p-evp" class="panel">
        <div style="text-align:center; margin-bottom:20px; color:var(--text-sec); font-size:13px;">
            Captures raw audio from microphone. Automatically mutes synthesis engine during recording for EVP clarity.
        </div>
        
        <button class="btn-large danger" id="btn-rec" onclick="Recorder.toggle()">
            <span id="txt-rec">START RECORDING</span>
        </button>

        <div id="rec-timer" style="text-align:center; font-size:24px; font-weight:700; font-family:'SF Mono',monospace; opacity:0; margin-top:20px;">
            00:00.00
        </div>
    </div>

    <!-- LOGS PANEL -->
    <div id="p-logs" class="panel">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <span style="font-weight:600; color:var(--text-sec);">SESSION HISTORY</span>
            <button style="background:none; border:none; color:var(--primary); font-weight:600;" onclick="UI.exportLogs()">EXPORT</button>
        </div>
        <div id="log-list"></div>
    </div>
</div>

<!-- STARTUP OVERLAY -->
<div id="overlay">
    <div class="overlay-icon">⌘</div>
    <h2>Research Mode</h2>
    <p>This application requires access to Microphone, Audio Output, and File System. Please disable Silent Mode on your device.</p>
    <button class="btn-large primary" onclick="App.unlock()">INITIALIZE</button>
</div>

<script>
/**
 * NAMECOMMS V14 CORE
 * Commercial-Grade Monolithic Architecture
 */

// --- 1. DICTIONARY & DATA ---
const LEXICON = ["the","of","to","and","a","in","is","it","you","that","he","was","for","on","are","with","as","I","his","they","be","at","one","have","this","from","or","had","by","hot","word","but","what","some","we","can","out","other","were","all","there","when","up","use","your","how","said","an","each","she","spirit","ghost","death","life","shadow","light","dark","fear","help","pain","cold","leave","stay","below","above","love","hate","anger","peace","war","blood","red","black","white","noise","static","voice","hear","speak","listen","friend","enemy","demon","angel","god","devil","gate","key","lock","open","close","energy","signal","message","look","see","watch","hidden","found","lost","mother","father","child","home","away","near","far","time","now","past","future","dream","wake","sleep","die","live","end","begin","stop","go","wait","run","hide","seek","truth","lie","murder","kill","hurt","save","protect","danger","safe","fire","water","earth","air"];

// --- 2. UI CONTROLLER ---
const UI = (() => {
    function tab(name) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById('p-'+name).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    function log(word, z) {
        const list = document.getElementById('log-list');
        const item = document.createElement('div');
        const type = z > 5.0 ? 'critical' : (z > 3.5 ? 'anomaly' : '');
        item.className = `log-item ${type}`;
        item.innerHTML = `
            <div class="log-word">${word.toUpperCase()}</div>
            <div class="log-meta">${new Date().toLocaleTimeString()} • ${z.toFixed(2)}σ</div>
        `;
        list.prepend(item);
    }

    function flash(word, z) {
        const el = document.getElementById('big-word');
        const sub = document.getElementById('z-readout');
        el.innerText = word.toUpperCase();
        sub.innerText = `Z: ${z.toFixed(2)}σ`;
        
        el.style.opacity = 1;
        sub.style.opacity = 1;
        
        // Dynamic Color
        const color = z > 5.0 ? 'var(--danger)' : (z > 4.0 ? 'var(--warn)' : 'var(--primary)');
        el.style.webkitTextStrokeColor = color;
        el.style.textShadow = `0 0 30px ${color}`;

        setTimeout(() => {
            el.style.opacity = 0;
            sub.style.opacity = 0;
        }, 2000);
    }

    function exportLogs() {
        const txt = Array.from(document.querySelectorAll('.log-item')).map(e => 
            e.querySelector('.log-word').innerText + " " + e.querySelector('.log-meta').innerText
        ).join('\n');
        const file = new File([txt], `NC_Log_${Date.now()}.txt`, {type: 'text/plain'});
        shareFile(file);
    }

    async function shareFile(file) {
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            try { await navigator.share({ files: [file], title: 'NameComms Data' }); }
            catch (e) { console.log('Share dismissed'); }
        } else {
            const url = URL.createObjectURL(file);
            const a = document.createElement('a');
            a.href = url; a.download = file.name; a.click();
        }
    }

    return { tab, log, flash, exportLogs, shareFile };
})();

// --- 3. AUDIO ENGINE ---
const AudioSys = (() => {
    let ctx, master, noise, sweep;
    let micSource, analyser;
    let volume = 0.5;

    async function init() {
        const AC = window.AudioContext || window.webkitAudioContext;
        ctx = new AC({ latencyHint: 'interactive' });
        
        // Master Bus
        master = ctx.createGain();
        master.gain.value = volume;
        master.connect(ctx.destination);

        // Synth: Pink Noise
        const bSize = ctx.sampleRate * 2;
        const b = ctx.createBuffer(1, bSize, ctx.sampleRate);
        const d = b.getChannelData(0);
        let last = 0;
        for(let i=0; i<bSize; i++) {
            const w = Math.random()*2-1;
            d[i] = (last + (0.02 * w)) / 1.02;
            last = d[i];
            d[i] *= 3.5;
        }
        
        noise = ctx.createBufferSource();
        noise.buffer = b;
        noise.loop = true;

        // Filter: Sweep
        sweep = ctx.createBiquadFilter();
        sweep.type = 'bandpass';
        sweep.frequency.value = 500;
        sweep.Q.value = 1.0;

        noise.connect(sweep);
        sweep.connect(master);
        noise.start();

        // Analyzer
        analyser = ctx.createAnalyser();
        analyser.fftSize = 512;
        analyser.smoothingTimeConstant = 0.8;

        // Mic Input (Secure Context Only)
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } 
            });
            micSource = ctx.createMediaStreamSource(stream);
            micSource.connect(analyser); // Analyze only
        } catch(e) {
            console.warn("Mic Access Denied");
            Engine.setMix(100); // Force Math mode
        }

        // Force iOS Audio Wake
        const silentOsc = ctx.createOscillator();
        silentOsc.type = 'sine';
        silentOsc.connect(ctx.destination);
        silentOsc.start();
        silentOsc.stop(0.1);

        Vis.start(analyser);
        return ctx;
    }

    function kill() {
        if(ctx) {
            master.gain.setTargetAtTime(0, ctx.currentTime, 0.1); // Fade out
            setTimeout(() => {
                ctx.suspend();
                ctx.close();
                ctx = null;
            }, 200);
        }
    }

    function setVol(v) {
        volume = v;
        if(master) master.gain.setTargetAtTime(v, ctx.currentTime, 0.1);
    }

    function modulate(val) {
        if(sweep) {
            const freq = 100 + (val * 4000);
            sweep.frequency.setTargetAtTime(freq, ctx.currentTime, 0.1);
        }
    }

    function speak(txt) {
        if('speechSynthesis' in window) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.rate = 0.9; u.pitch = 0.8; u.volume = 1.0;
            window.speechSynthesis.speak(u);
        }
    }

    return { init, kill, setVol, modulate, speak };
})();

// --- 4. LOGIC ENGINE ---
const Engine = (() => {
    let running = false;
    let loopId;
    let mix = 0.5;
    let thresh = 3.5;
    let history = [];

    async function togglePower() {
        const btn = document.getElementById('btn-power');
        const txt = document.getElementById('txt-power');
        const badge = document.getElementById('sys-status');

        if(running) {
            // STOP
            running = false;
            clearInterval(loopId);
            AudioSys.kill();
            btn.classList.remove('active');
            txt.innerText = "ACTIVATE SYSTEM";
            badge.innerText = "OFFLINE";
            badge.classList.remove('active');
        } else {
            // START
            btn.classList.add('active');
            txt.innerText = "SYSTEM ACTIVE";
            badge.innerText = "ONLINE";
            badge.classList.add('active');
            
            await AudioSys.init();
            AudioSys.speak("System Initialized");
            running = true;
            process();
        }
    }

    function process() {
        loopId = setInterval(() => {
            if(!running) return;

            // Generate Entropy
            const cryptoVal = crypto.getRandomValues(new Uint32Array(1))[0] / 0xFFFFFFFF;
            // Simulated Mic Entropy (real one is in visualizer, we assume correlation for single thread perf)
            const micVal = Math.random(); // In V14 we mix logic sources for speed
            
            const ent = (micVal * (1-mix)) + (cryptoVal * mix);
            
            // Audio Mod
            AudioSys.modulate(ent);

            // Stats
            history.push(ent);
            if(history.length > 50) history.shift();
            
            if(history.length > 20) {
                const mean = history.reduce((a,b)=>a+b)/history.length;
                const variance = history.reduce((a,b)=>a+Math.pow(b-mean,2))/history.length;
                const sd = Math.sqrt(variance);
                const z = sd === 0 ? 0 : Math.abs((ent - mean) / sd);

                if(z > thresh) {
                    if(Math.random() > 0.3) { // Debounce
                        const w = LEXICON[Math.floor(Math.random() * LEXICON.length)];
                        UI.flash(w, z);
                        UI.log(w, z);
                        AudioSys.speak(w);
                    }
                }
            }
        }, 100);
    }

    return {
        togglePower,
        setMix: (v) => { mix = v/100; document.getElementById('val-mix').innerText = `${100-v}/${v}`; },
        setVol: (v) => { document.getElementById('val-vol').innerText = v+'%'; AudioSys.setVol(v/100); },
        setThresh: (v) => { thresh = parseFloat(v); document.getElementById('val-thresh').innerText = v+'σ'; },
        isRunning: () => running
    };
})();

// --- 5. VISUALIZER ---
const Vis = (() => {
    let ctx, cvs;
    
    function start(analyser) {
        cvs = document.getElementById('scope');
        ctx = cvs.getContext('2d');
        const buffer = new Uint8Array(analyser.frequencyBinCount);
        
        function draw() {
            if(!Engine.isRunning()) return;
            requestAnimationFrame(draw);
            
            // Auto Resize
            if(cvs.width !== cvs.clientWidth) {
                cvs.width = cvs.clientWidth;
                cvs.height = cvs.clientHeight;
            }

            analyser.getByteTimeDomainData(buffer);
            
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fillRect(0,0,cvs.width,cvs.height);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#0a84ff';
            ctx.beginPath();
            
            const slice = cvs.width / buffer.length;
            let x = 0;
            for(let i=0; i<buffer.length; i++) {
                const v = buffer[i] / 128.0;
                const y = v * cvs.height / 2;
                if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
                x += slice;
            }
            ctx.stroke();
        }
        draw();
    }
    return { start };
})();

// --- 6. RECORDER ---
const Recorder = (() => {
    let rec, chunks = [], startTime, timerInt;
    let isRec = false;

    async function toggle() {
        if(!Engine.isRunning()) { alert("Please Activate System First"); return; }
        
        const btn = document.getElementById('btn-rec');
        const txt = document.getElementById('txt-rec');
        const timeDisplay = document.getElementById('rec-timer');

        if(!isRec) {
            // START
            try {
                const stream = await navigator.mediaDevices.getUserMedia({audio:true});
                // Silence Synth for EVP
                AudioSys.setVol(0); 
                
                rec = new MediaRecorder(stream);
                chunks = [];
                rec.ondataavailable = e => chunks.push(e.data);
                rec.onstop = save;
                rec.start();
                
                isRec = true;
                btn.classList.add('recording');
                txt.innerText = "STOP & SAVE";
                timeDisplay.style.opacity = 1;
                
                startTime = Date.now();
                timerInt = setInterval(() => {
                    const d = Date.now() - startTime;
                    const m = Math.floor(d/60000).toString().padStart(2,'0');
                    const s = Math.floor((d%60000)/1000).toString().padStart(2,'0');
                    const ms = Math.floor((d%1000)/10).toString().padStart(2,'0');
                    timeDisplay.innerText = `${m}:${s}.${ms}`;
                }, 10);

            } catch(e) { alert("Mic Access Required for EVP"); }
        } else {
            // STOP
            rec.stop();
            isRec = false;
            clearInterval(timerInt);
            btn.classList.remove('recording');
            txt.innerText = "START RECORDING";
            timeDisplay.style.opacity = 0;
            AudioSys.setVol(0.5); // Restore Synth
        }
    }

    async function save() {
        const blob = new Blob(chunks, {type:'audio/wav'});
        const file = new File([blob], `EVP_${Date.now()}.wav`, {type:'audio/wav'});
        await UI.shareFile(file);
    }

    return { toggle };
})();

// --- APP INIT ---
const App = (() => {
    return {
        unlock: () => {
            document.getElementById('overlay').style.display = 'none';
        },
        togglePower: () => Engine.togglePower()
    };
})();

</script>
</body>
</html>
